<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPS Tracker - Firebase</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.development.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.development.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            margin: 0; 
            background: #f3f4f6; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        .icon {
            width: 16px;
            height: 16px;
            display: inline-block;
            vertical-align: middle;
        }
        .icon-lg {
            width: 20px;
            height: 20px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Ícones SVG simples
        const MapIcon = ({ className = "icon" }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                <circle cx="12" cy="10" r="3"></circle>
            </svg>
        );

        const WifiIcon = ({ className = "icon" }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M1.42 9a16 16 0 0 1 21.16 0"></path>
                <path d="M5 12.55a11 11 0 0 1 14.08 0"></path>
                <path d="M8.53 16.11a6 6 0 0 1 6.95 0"></path>
                <circle cx="12" cy="20" r="1"></circle>
            </svg>
        );

        const WifiOffIcon = ({ className = "icon" }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <line x1="2" y1="2" x2="22" y2="22"></line>
                <path d="M8.5 16.5a5 5 0 0 1 7 0"></path>
                <path d="M2 8.82a15 15 0 0 1 4.17-2.65"></path>
                <path d="M10.66 5c4.01-.36 8.14.9 11.34 3.76"></path>
                <path d="M16.85 11.25a10 10 0 0 1 2.22 1.68"></path>
                <path d="M5 13a10 10 0 0 1 5.36-2.17"></path>
            </svg>
        );

        const PlayIcon = ({ className = "icon" }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polygon points="5,3 19,12 5,21"></polygon>
            </svg>
        );

        const StopIcon = ({ className = "icon" }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <rect x="6" y="6" width="12" height="12"></rect>
            </svg>
        );

        const FirebaseGPSTracker = () => {
            const [isTracking, setIsTracking] = useState(false);
            const [location, setLocation] = useState(null);
            const [lastSent, setLastSent] = useState(null);
            const [status, setStatus] = useState('Parado');
            const [error, setError] = useState(null);
            const [watchId, setWatchId] = useState(null);

            const FIREBASE_URL = 'https://vigicolera-default-rtdb.firebaseio.com/localizacoes.json';

            const sendLocationToFirebase = async (lat, lng) => {
                try {
                    const data = {
                        dispositivo: "telemovel-paulo",
                        lat: lat.toString(),
                        lng: lng.toString(),
                        timestamp: new Date().toISOString()
                    };

                    const response = await fetch(FIREBASE_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data)
                    });

                    if (response.ok) {
                        setLastSent(new Date().toLocaleTimeString());
                        setStatus('✅ Enviado com sucesso');
                        setError(null);
                    } else {
                        throw new Error(`Erro HTTP: ${response.status}`);
                    }
                } catch (err) {
                    setError(`❌ Erro ao enviar: ${err.message}`);
                    setStatus('Erro no envio');
                }
            };

            const handleLocationUpdate = (position) => {
                const { latitude, longitude } = position.coords;
                setLocation({
                    lat: latitude,
                    lng: longitude,
                    accuracy: position.coords.accuracy,
                    timestamp: new Date()
                });

                if (isTracking) {
                    sendLocationToFirebase(latitude, longitude);
                }
            };

            const handleLocationError = (error) => {
                let errorMessage = '';
                switch (error.code) {
                    case error.PERMISSION_DENIED:
                        errorMessage = "❌ Permissão de localização negada";
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMessage = "❌ Localização indisponível";
                        break;
                    case error.TIMEOUT:
                        errorMessage = "⏱️ Timeout na obtenção da localização";
                        break;
                    default:
                        errorMessage = "❌ Erro desconhecido";
                        break;
                }
                setError(errorMessage);
                setStatus('Erro GPS');
            };

            const startTracking = () => {
                if (!navigator.geolocation) {
                    setError('❌ GPS não suportado neste navegador');
                    return;
                }

                const options = {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                };

                const id = navigator.geolocation.watchPosition(
                    handleLocationUpdate,
                    handleLocationError,
                    options
                );

                setWatchId(id);
                setIsTracking(true);
                setStatus('🔄 Rastreando...');
                setError(null);
            };

            const stopTracking = () => {
                if (watchId) {
                    navigator.geolocation.clearWatch(watchId);
                    setWatchId(null);
                }
                setIsTracking(false);
                setStatus('⏹️ Parado');
            };

            const sendCurrentLocation = () => {
                if (!navigator.geolocation) {
                    setError('❌ GPS não suportado neste navegador');
                    return;
                }

                setStatus('📍 Obtendo localização...');
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        setLocation({
                            lat: latitude,
                            lng: longitude,
                            accuracy: position.coords.accuracy,
                            timestamp: new Date()
                        });
                        sendLocationToFirebase(latitude, longitude);
                    },
                    handleLocationError,
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            };

            useEffect(() => {
                return () => {
                    if (watchId) {
                        navigator.geolocation.clearWatch(watchId);
                    }
                };
            }, [watchId]);

            return (
                <div className="max-w-md mx-auto bg-white rounded-lg shadow-lg p-6 m-4">
                    {/* Header */}
                    <div className="text-center mb-6">
                        <h1 className="text-2xl font-bold text-gray-800 flex items-center justify-center gap-2">
                            <MapIcon className="icon-lg text-blue-500" />
                            GPS Tracker
                        </h1>
                        <p className="text-gray-600">Firebase Real-time</p>
                    </div>

                    {/* Status */}
                    <div className="mb-6 p-4 rounded-lg bg-gray-50">
                        <div className="flex items-center justify-between mb-2">
                            <span className="text-sm font-medium text-gray-600">Status:</span>
                            <div className="flex items-center gap-2">
                                {isTracking ? (
                                    <WifiIcon className="icon text-green-500" />
                                ) : (
                                    <WifiOffIcon className="icon text-gray-400" />
                                )}
                                <span className={`text-sm font-medium ${
                                    status.includes('sucesso') ? 'text-green-600' : 
                                    status.includes('Erro') ? 'text-red-600' : 'text-gray-600'
                                }`}>
                                    {status}
                                </span>
                            </div>
                        </div>
                        
                        {lastSent && (
                            <div className="text-xs text-gray-500">
                                Último envio: {lastSent}
                            </div>
                        )}
                    </div>

                    {/* Location Info */}
                    {location && (
                        <div className="mb-6 p-4 rounded-lg bg-blue-50">
                            <h3 className="font-medium text-blue-800 mb-2">📍 Localização Atual:</h3>
                            <div className="text-sm text-blue-700 space-y-1">
                                <div><strong>Lat:</strong> {location.lat.toFixed(6)}</div>
                                <div><strong>Lng:</strong> {location.lng.toFixed(6)}</div>
                                <div><strong>Precisão:</strong> {location.accuracy?.toFixed(0)}m</div>
                                <div className="text-xs">
                                    <strong>Hora:</strong> {location.timestamp.toLocaleString()}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Error Message */}
                    {error && (
                        <div className="mb-6 p-4 rounded-lg bg-red-50 border border-red-200">
                            <p className="text-red-700 text-sm">{error}</p>
                        </div>
                    )}

                    {/* Controls */}
                    <div className="space-y-3">
                        <button
                            onClick={sendCurrentLocation}
                            disabled={isTracking}
                            className="w-full bg-blue-500 hover:bg-blue-600 disabled:bg-gray-300 text-white font-medium py-4 px-4 rounded-lg transition-colors flex items-center justify-center gap-2 text-lg"
                        >
                            <MapIcon className="icon-lg" />
                            📍 Enviar Localização Atual
                        </button>

                        <div className="flex gap-3">
                            <button
                                onClick={startTracking}
                                disabled={isTracking}
                                className="flex-1 bg-green-500 hover:bg-green-600 disabled:bg-gray-300 text-white font-medium py-4 px-4 rounded-lg transition-colors flex items-center justify-center gap-2"
                            >
                                <PlayIcon className="icon" />
                                ▶️ Iniciar
                            </button>

                            <button
                                onClick={stopTracking}
                                disabled={!isTracking}
                                className="flex-1 bg-red-500 hover:bg-red-600 disabled:bg-gray-300 text-white font-medium py-4 px-4 rounded-lg transition-colors flex items-center justify-center gap-2"
                            >
                                <StopIcon className="icon" />
                                ⏹️ Parar
                            </button>
                        </div>
                    </div>

                    {/* Info */}
                    <div className="mt-6 p-4 rounded-lg bg-gray-50">
                        <h4 className="font-medium text-gray-800 mb-2">ℹ️ Informações:</h4>
                        <ul className="text-xs text-gray-600 space-y-1">
                            <li>📱 Dispositivo: telemovel-paulo</li>
                            <li>🔥 Firebase: vigicolera-default-rtdb</li>
                            <li>🔄 Modo contínuo envia a cada mudança</li>
                            <li>🔐 Requer permissão de localização</li>
                        </ul>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<FirebaseGPSTracker />, document.getElementById('root'));
    </script>
</body>
</html>
